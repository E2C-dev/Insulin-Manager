# 調整ルール管理機能

インスリン投与量を血糖値に基づいて自動調整するためのルール管理機能です。

## 機能概要

血糖値の測定結果に応じて、次回のインスリン投与量を調整するルールを設定・管理できます。

### 例：ユーザー様の要望に基づくルール

#### 朝のルール
- **夜間低血糖70以下**: 眠前 -2単位
- **朝70以下**: 眠前 -1単位
- **朝100以上**: 眠前 +2単位

#### 昼夜のルール
- **食後1h 140以上**: 翌日同食事 +2単位
- **食後1h 80以下**: 翌日同食事 -1単位

## 実装内容

### 📊 データベース

**adjustmentRulesテーブル**
```sql
- id (UUID): 主キー
- userId (UUID): ユーザーID（外部キー）
- name (TEXT): ルール名
- timeSlot (TEXT): 時間帯（朝、昼、夜、眠前など）
- conditionType (TEXT): 条件タイプ（夜間低血糖、食後1hなど）
- threshold (INTEGER): 閾値（mg/dL）
- comparison (TEXT): 比較演算子（以下、以上、未満、超える）
- adjustmentAmount (INTEGER): 調整量（単位）-20〜+20
- targetTimeSlot (TEXT): 調整対象の時間帯
- createdAt (TIMESTAMP): 作成日時
- updatedAt (TIMESTAMP): 更新日時
```

### 🔧 バックエンドAPI

#### エンドポイント一覧

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/api/adjustment-rules` | ルール一覧取得 |
| GET | `/api/adjustment-rules/:id` | ルール詳細取得 |
| POST | `/api/adjustment-rules` | ルール作成 |
| PUT | `/api/adjustment-rules/:id` | ルール更新 |
| DELETE | `/api/adjustment-rules/:id` | ルール削除 |

#### リクエスト例（ルール作成）

```json
{
  "name": "夜間低血糖対応",
  "timeSlot": "朝",
  "conditionType": "夜間低血糖",
  "threshold": 70,
  "comparison": "以下",
  "adjustmentAmount": -2,
  "targetTimeSlot": "眠前"
}
```

#### レスポンス例

```json
{
  "message": "ルールを作成しました",
  "rule": {
    "id": "uuid-here",
    "userId": "user-uuid",
    "name": "夜間低血糖対応",
    "timeSlot": "朝",
    "conditionType": "夜間低血糖",
    "threshold": 70,
    "comparison": "以下",
    "adjustmentAmount": -2,
    "targetTimeSlot": "眠前",
    "createdAt": "2025-12-15T...",
    "updatedAt": "2025-12-15T..."
  }
}
```

### 🎨 フロントエンド

#### ページ構成

**調整ルール管理ページ** (`/adjustment-rules`)
- ルール一覧表示
- ルール作成ダイアログ
- ルール編集機能
- ルール削除機能

#### UI機能

1. **ルール一覧**
   - カード形式で表示
   - 時間帯バッジ表示
   - 条件と調整内容を視覚的に表示
   - 編集・削除ボタン

2. **ルール作成・編集フォーム**
   - ルール名入力
   - 時間帯選択（朝、昼、夜、眠前）
   - 条件タイプ入力
   - 閾値入力（数値）
   - 比較演算子選択（以下、以上、未満、超える）
   - 調整量入力（-20〜+20単位）
   - 調整対象時間帯入力

3. **バリデーション**
   - 必須項目チェック
   - 数値範囲チェック
   - リアルタイムエラー表示

## 使い方

### 1. ルールの作成

1. ナビゲーションメニューから「ルール」をタップ
2. 「新規ルール」ボタンをクリック
3. フォームに情報を入力：
   - **ルール名**: 分かりやすい名前（例：夜間低血糖対応）
   - **時間帯**: いつのデータを見るか（朝、昼、夜、眠前）
   - **条件タイプ**: 説明文（例：夜間低血糖）
   - **閾値**: 血糖値（例：70）
   - **比較**: 以下、以上、未満、超える
   - **調整量**: インスリンの増減（例：-2）
   - **調整対象**: どこを調整するか（例：眠前）
4. 「作成」ボタンをクリック

### 2. ルールの編集

1. ルールカードの編集アイコン（鉛筆マーク）をクリック
2. 数値や条件を変更
3. 「更新」ボタンをクリック

### 3. ルールの削除

1. ルールカードの削除アイコン（ゴミ箱マーク）をクリック
2. 確認ダイアログで「OK」をクリック

## 設定例

### 例1：夜間低血糖への対応

```
ルール名: 夜間低血糖70以下
時間帯: 朝
条件タイプ: 夜間低血糖
閾値: 70 mg/dL
比較: 以下
調整量: -2 単位
調整対象: 眠前
```

### 例2：食後高血糖への対応

```
ルール名: 食後1時間140以上
時間帯: 昼
条件タイプ: 食後1h
閾値: 140 mg/dL
比較: 以上
調整量: +2 単位
調整対象: 翌日同食事
```

### 例3：朝の低血糖への対応

```
ルール名: 朝70以下
時間帯: 朝
条件タイプ: 朝食前血糖
閾値: 70 mg/dL
比較: 以下
調整量: -1 単位
調整対象: 眠前
```

## アクセス方法

### ナビゲーションから
- 下部メニューバーの「ルール」アイコンをタップ

### 設定ページから
- 設定 → 「調整ルール管理」をタップ

## セキュリティ

- ✅ ユーザー認証必須（未ログインではアクセス不可）
- ✅ ユーザーごとのデータ分離（他のユーザーのルールは見えない）
- ✅ バリデーション（フロントエンド・バックエンド両方）
- ✅ 入力値の範囲制限（調整量: -20〜+20単位）

## 今後の拡張可能性

1. **ルールの優先順位設定**
   - 複数のルールが該当する場合の優先順位

2. **ルールの有効/無効切り替え**
   - 一時的にルールを無効化

3. **ルールのグループ化**
   - 季節別、体調別などでグループ管理

4. **自動適用機能**
   - 血糖値記録時に該当ルールを自動検出
   - 推奨調整量を自動表示

5. **ルールの効果分析**
   - ルールを適用した後の血糖値変化を分析
   - 効果的なルールを可視化

6. **ルールのエクスポート/インポート**
   - 医師との共有
   - バックアップと復元

## 技術スタック

- **データベース**: PostgreSQL + Drizzle ORM
- **バックエンド**: Express.js + TypeScript
- **フロントエンド**: React + TypeScript + TanStack Query
- **UI**: Radix UI + Tailwind CSS
- **バリデーション**: Zod
- **認証**: Passport.js

## トラブルシューティング

### ルールが作成できない
- すべての必須項目が入力されているか確認
- 調整量が-20〜+20の範囲内か確認
- ログインしているか確認

### ルールが表示されない
- ページを再読み込み
- ログインしているユーザーが正しいか確認

### 編集が保存されない
- ネットワーク接続を確認
- ブラウザのコンソールでエラーを確認
