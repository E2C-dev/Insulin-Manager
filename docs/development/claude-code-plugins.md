# Claude Code プラグイン（永続化と表示されない場合の対処）

## 概要

Claude Code 専用プラグインをプロジェクトで使う際、Replit 等のクラウド環境では「毎回表示されない」「毎回インストールが必要」と感じることがあります。このドキュメントでは原因と、永続化のための推奨手順をまとめます。

## Replit での永続化（このリポジトリの設定）

Replit では**ワークスペース（プロジェクトフォルダ）だけが永続化**され、ホーム直下（`/home/runner`）はセッションでリセットされるため、`~/.claude` に置かれたプラグインが消えてしまいます。

このリポジトリでは、**Replit の起動時に `~/.claude` をワークスペース内の `.claude-user` へシンボリックリンクする**設定を入れています。

- **スクリプト**: [script/setup-claude-home.sh](../../script/setup-claude-home.sh)  
  起動時に `~/.claude` を `workspace/.claude-user` へのリンクに差し替えます。
- **呼び出し**: [.replit](../../.replit) の `run` で、`npm run dev` の前に `bash script/setup-claude-home.sh` を実行しています。
- **永続化**: `.claude-user` はワークスペース内のため Replit が保存し、プラグインやキャッシュが残ります。`.gitignore` で `.claude-user` を除外しているため、リポジトリにはコミットされません。

**必要な作業**: なし。Replit で「Run」して通常どおり開発するだけで、2回目以降も Claude Code のプラグインが使える状態が維持されます。初回または新しい Repl では、プラグインを一度インストール（ユーザースコープで問題ありません）すれば、その後は永続化されます。

## 毎回表示されない主な原因

1. **ユーザースコープでインストールしている**  
   プラグイン情報が `~/.claude/` にのみ保存され、環境がリセットされると消えます。

2. **キャッシュ不整合**  
   インストール済みなのに一覧に出てこない場合は、プラグインキャッシュの不整合の可能性があります。

## 推奨: プロジェクトスコープでインストールする

プロジェクトスコープでインストールすると、有効なプラグイン一覧が **`.claude/settings.json`** の `enabledPlugins` に保存され、リポジトリにコミットすれば環境をまたいで再現されます。

### 手順

1. Claude Code で `/plugin` を実行し、プラグインマネージャーを開く。
2. **Discover** タブで使いたいプラグインを選び、インストール時に **「プロジェクトスコープ」** を選択する。
3. コマンドで入れる場合は、プロジェクトスコープを指定する:
   ```bash
   # 例: 公式マーケットプレイスの commit-commands をプロジェクトスコープで
   /plugin install commit-commands@claude-plugins-official
   # スコープは UI で「プロジェクトスコープ」を選択するか、CLI で --scope project を指定
   ```
4. インストール後、`.claude/settings.json` に `enabledPlugins` のエントリが追加されていることを確認し、**その変更をコミット**する。

これにより、新しい環境でリポジトリを開いたときも「このプロジェクトで有効なプラグイン」の情報が残り、表示・有効化の再現性が上がります。

## 表示されないときの対処（キャッシュ）

「インストールしたのに一覧に表示されない」場合は、公式推奨のキャッシュ削除を試してください。

```bash
rm -rf ~/.claude/plugins/cache
```

その後、Claude Code を再起動し、必要なら該当プラグインを再インストールしてください。

## 参考リンク

- [プラグインの発見とインストール（公式）](https://code.claude.com/docs/ja/discover-plugins)
- [設定スコープ・プラグイン設定（公式）](https://code.claude.com/ja/settings#plugin-settings)
